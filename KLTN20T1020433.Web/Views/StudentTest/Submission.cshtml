@model KLTN20T1020433.Web.Models.SubmissionModel
@{
    Layout = null;
}
<div id="submission">
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="card-text">Bài nộp của bạn</h4>
                <p class="card-text text-dark" id="submissionStatus">@Model.Submission.StatusDescription</p>

            </div>
        </div>
        <div class="card-body pt-0" >
            <!-- Hiển thị file bài nộp của sinh viên -->
            <div class="mb-3">
                <div id="submission_files">
                </div>
                <form action="UploadSubmissionFile" class="form-group" enctype="multipart/form-data">
                    <input type="hidden" name="SubmissionId" value="@Model.Submission.SubmissionId" />
                    <input type="hidden" name="TestId" value="@Model.Submission.TestId" />
                    <input type="file" class="d-none" multiple id="fileInput" />
                    @if (Model.Submission.Status == KLTN20T1020433.DomainModels.Enum.SubmissionStatus.NotSubmitted)
                    {
                        <button id="selectFileBtn" type="button" class="btn btn-outline-secondary form-control">Thêm file</button>
                    }
                </form>

                @if (Model.Submission.Status == KLTN20T1020433.DomainModels.Enum.SubmissionStatus.NotSubmitted)
                {
                    <button class="btn btn-primary mt-4 form-control" type="button" onclick="submit(@Model.Submission.SubmissionId)" id="submitBtn">Nộp bài</button>
                }
                else
                {
                    <button class="btn btn-primary mt-4 form-control" type="button" onclick="cancel(@Model.Submission.SubmissionId)" id="cancelBtn">Hủy nộp bài</button>
                }

            </div>
        </div>
    </div>
    <div class="card">
        <div class="bg-white py-3 ms-4">
            <div class="d-flex align-items-center">
                <span><i class="ti ti-user me-2"></i></span>
                <span class="card-title mb-0">1 nhận xét riêng tư</span>
            </div>
        </div>
        <div class="mb-3 ms-4">
            <div class="container">
                <div class="row align-items-center">
                    @foreach (var item in Model.Comments)
                    {
                        <div class="col">
                            <div class="d-flex justify-content-between">
                                <p class="mb-0  "><strong>@item.TeacherName</strong></p>
                                <p class="mb-0 text-muted">@item.CommentedTime</p>
                            </div>
                            <p class="mb-0  fw-bold text-dark">@item.Body</p>
                        </div>
                    }

                </div>
            </div>
        </div>

    </div>
</div>

<script>
    $('#selectFileBtn').off('click').on('click', function () {
        console.log("b");
        $('#fileInput').click();
    });
    $(document).on('click', '.remove-button', function () {
        var fileId = $(this).data('fileid');
        console.log(fileId);
        var url = '@Url.Action("RemoveSubmissionFile", "StudentTest")';
        $.ajax({
            url: url,
            type: 'POST',
            data: { id: fileId },
            success: function (response) {
                getFiles(@Model.Submission.SubmissionId);                
            },
            error: function (xhr, status, error) {
                alert("Your request is not valid!");
            }
        });
    });
    $('#fileInput').off('change').on('change', function () {
        var formData = new FormData();
        console.log("a");
        var files = $(this)[0].files;
        files.forEach(function (file) {
            formData.append('files', file);
        });
        var submissionId = $('[name="SubmissionId"]').val();
        var testId = $('[name="TestId"]').val();
        formData.append('submissionId', submissionId);
        formData.append('testId', testId);

        uploadFiles(formData);
    });
    $(document).ready(function () {
        getFiles(@Model.Submission.SubmissionId);
    });
    function uploadFiles(formData) {
        console.log("c");
        var url = '@Url.Action("UploadSubmissionFile", "StudentTest")';
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                $('#fileInput').val('');
                getFiles(@Model.Submission.SubmissionId);                
            },
            error: function (xhr, status, error) {
                alert("Your request is not valid!");
            }
        });
    }
    function getFiles(submissionId) {
        var url = '@Url.Action("ListSubmissionFiles", "StudentTest")';
        $.ajax({
            url: url,
            type: "GET",
            data: { submissionId: submissionId },
            error: function () {
                var errorMessage = xhr.responseText; 
                alert(errorMessage);
            },
            success: function (data) {
                $("#submission_files").html(data);
            }
        });
    }
    function submit(submissionId) {
        var url = '@Url.Action("Submit", "StudentTest")';
        $.ajax({
            url: url,
            type: 'POST',
            data: { id: submissionId },
            success: function (data) {
                $("#submission").html(data);
                getFiles(submissionId);
            },
            error: function (xhr, status, error) {
                var errorMessage = xhr.responseText; 
                alert(errorMessage);
            }
        });
    }
    function cancel(submissionId) {

        var url = '@Url.Action("Cancel", "StudentTest")';
        $.ajax({
            url: url,
            type: 'POST',
            data: { id: submissionId },
            success: function (data) {
                $("#submission").html(data);
                getFiles(submissionId);
            },
            error: function (xhr, status, error) {
                var errorMessage = xhr.responseText; 
                alert(errorMessage);
            }
        });
    }
</script>

